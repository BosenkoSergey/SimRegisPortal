@page "/companies"
@inherits BaseComponent

@using SimRegisPortal.Application.Features.Companies.Queries

@attribute [Authorize]

<PageTitle>Companies</PageTitle>

<MudPaper Class="mt-3 px-3 py-3">
    <MudDataGrid Items="_companies" @ref="_grid" Filterable="true" Dense>

        <ToolBarContent>
            <MudText Typo="Typo.h6">Companies</MudText>
            <MudSpacer />
            @if (UserContext.HasPermission(UserPermissionType.CompaniesWrite))
            {
                <MudButton OnClick="AddCompany" StartIcon="@Icons.Material.Filled.CreateNewFolder" Variant="Variant.Outlined" Class="ml-2">
                    Add
                </MudButton>
            }
        </ToolBarContent>

        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.TaxNumber" Title="Tax Number" />
            <PropertyColumn Property="x => x.RegistrationNumber" Title="Registration Number" />
            <PropertyColumn Property="x => x.Phone" Title="Phone" />
            <PropertyColumn Property="x => x.Email" Title="Email" />
            <PropertyColumn Property="x => x.ContactPerson" Title="Contact Person" />

            <TemplateColumn>
                <CellTemplate Context="context">
                    <MudIconButton OnClick="@(() => EditCompany(context.Item.Id))" Icon="@Icons.Material.Outlined.Edit" Size="Size.Small" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>

        <PagerContent>
            <MudDataGridPager />
        </PagerContent>

    </MudDataGrid>
</MudPaper>

@code {
    private List<CompanyDto> _companies = new();
    private MudDataGrid<CompanyDto>? _grid;

    protected override async Task OnFirstInitializedAsync()
    {
        if (!UserContext.HasPermission(UserPermissionType.CompaniesRead))
        {
            NavManager.NavigateTo("/auth/denied", forceLoad: true);
            return;
        }

        var result = await SendSafeAsync(new GetCompaniesQuery());
        if (result.IsSuccess)
        {
            _companies = result.Value!.ToList();
        }
    }

    private void AddCompany()
    {
        NavManager.NavigateTo("/company");
    }

    private void EditCompany(Guid id)
    {
        NavManager.NavigateTo($"/company/{id}");
    }
}
